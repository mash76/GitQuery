<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>GitQuery</title>
    <link href="./style.css" rel="stylesheet" type="text/css" />
  </head>
  <body>

    <!-- header -->

    <div class="underline" style="padding:3px;">
      <table width="100%" style="padding:0px;margin:0px;">
        <tr>
          <td width="50%" valign="top" >
            <span id="version" class="silver s80" >**version**</span>
            <span onClick="toggleDevTools()" class="btn s80" >devTools</span>
            <span onClick="$('#nodejs_info').slideToggle(10)" class="btn s80" >node-<span id="node_version"></span></span>
          </td>
          <td width="50%" align="right" >
            <span id="g_user" class="silver s80" ></span>
            <span onClick="$('#gitconf').toggle();" class="btn s80"> ~/.gitconfig ~/.gitignore_global</span>
          </td>
        </tr>
      </table>

      <div id="nodejs_info" class="detail hide s80"></div>
      <div id="gitconf" class="hide s80 detail" style="text-align:left;"></div>

      <span onClick="togglePaneLocalRepoList()" class="btn s120" >Repositories</span>
      <span onClick="alert('construction');" class="btn" >init</span>
      <span id="his_repo"></span>
    </div>

    <!-- list : local repositories -->

    <div id="local_repo_pane" class="detail" >
      <input type="text" id="filter_l_repo" size=20 />
      <div id="local_repo_list"></div>
    </div>

    <!-- current repository  -->

    <div id="repo_info" class="m10 hide">
        <span id="current_repo_name" class="bold s170">**current_repo**</span>
        <span id="current_repo_path" class="silver">**current_repo_path**</span>
        <span onClick="osrun('open ' + path2dir(current_repo_path) )"  class="btn s80">finder</span>

        <span onClick="osRunOut('git fetch','os_result')" class="btn s120">fetch</span>
        <span onClick="osRunOut('git pull','os_result')" class="btn s120">pull</span>
        <span onClick="osRunOut('git push','os_result')" class="btn s120">push</span>

        <br/>

        <span onClick="showBranchList()" >
          <span class="btn">branch</span><span id="local_branch_ct" class="btn s120 bold">**local_branch_ct**</span>
        </span>

        <span onClick="showIgnore()" class="btn">.gitignore</span>
        <span onClick="osrun('ls ' + current_repo_path + '/hooks','repo_out'); togglePaneCurrentRepoDesc('hooks')" class="btn">hooks</span>
        <span onClick="osrun('git submodule status','repo_out'); togglePaneCurrentRepoDesc('hooks')" class="btn">submodule</span>

        <span onClick="showGitmodules()" class="btn">.gitmodules</span>

        <span onClick="osrun('git stash list','repo_out'); togglePaneCurrentRepoDesc('stash')" class="btn">stash</span>
        <span onClick="osrun('cat ' + current_repo_path + '/config','repo_out'); togglePaneCurrentRepoDesc('config')" class="btn">config</span>


        Remote
        <span onClick="osrun('git remote -v','repo_out'); togglePaneCurrentRepoDesc('remote')" class="btn">repo</span>

        <span onClick="osrun('git branch -r','repo_out'); togglePaneCurrentRepoDesc('remotebranch')" >
          <span class="btn">branch</span><span id="remote_branch_ct" class="btn s120 bold">**remote_branch_ct**</span>
        </span>

        <br/>

        <div id="repo_out" class="s80 hide detail" >repo_out</div>

        <!-- current branch -->

        <span id="c_branch" class="s170 bold">**c_branch**</span>

        <span class="gray">
          <a href="javascript:void(0)" onClick="showFiles('')" >
            files<span id="br_files_ct" class="bold s150">**br_files_ct**</span>
          </a>
          <a href="javascript:void(0)" onClick="logTable('')" >
            commit<span id="br_commit_ct" class="bold s150">**br_commit_ct**</span>
          </a>



           <span id="latest_commit" class="s80 gray">97f809b  4 minutes ago</span>
           <a href="javascript:void(0)" onClick="showMemberList()" >
             comitter<span id="br_member_ct" class="bold s150">**br_member_ct**</span>
           </a>
        <br/>

        <span onClick="showGitStatus()"  class="btn">status</span>
        <span onClick="osRunOut('git add .','os_result')"  class="btn">add</span>
        <span onClick="osRunOut('git reset','os_result')"  class="btn">reset</span>
        <span onClick="osRunOut('git diff ','os_result')"  class="btn s80">diff</span>

        <span class="s80 gray">ChangeFiles</span>


        <span onClick="osRunOut('git diff HEAD~5 HEAD --name-only ','os_result')" class="btn s80">5c</span>
        <span onClick="osRunOut('git diff HEAD~10 HEAD --name-only ','os_result')" class="btn s80">10c</span>
        <span onClick="osRunOut('git diff HEAD~30 HEAD --name-only ','os_result')" class="btn s80">30c</span>
        <span onClick="osRunOut('git diff HEAD~100 HEAD --name-only ','os_result')" class="btn s80">100c</span>


        <span onClick="osRunOut('git log --graph --oneline ','os_result')" class="btn s80">tree1</span>

        <div id="os_result" class="detail s80">os_result</div>

        <div class="m10">
            current repo info
            <span onClick="findLocalRepos()" class="btn s80">files</span>
            <div id="c_repo_info" class="underline s80"> </div>

            <span onClick="$('div[name=file_detail]').toggle();" class="btn">toggle</span>
            btn
            <br/>
            <span id="c_repo_pane" >c_repo_pane</span>
        </div>

        <br/><br/>
        <div id="real_files"></div>

        <div id="os_out" style="font-size:60%;font-color:silver;"></div>
        init<br/>
        <input id="init_path" type="text" placeholder="init_path" />
        <button onClick="osrun('git remote add  \'' + $('#remote_name').val() + '\' \'' + $('#remote_url').val() +'\'')" placeholder="git command" />add</button>

        <br/>
        git command <br/>
        <input id="git_usercommand" type="text" size="70" placeholder="git command" />
        <button onClick="osrun($('#git_usercommand').val(),'os_result')" placeholder="git command" />run</button>
        <br/>
        clone url<br/>
        <input id="clone_url" type="text" placeholder="clone_url" />
        <br/>
        stash <span class="silver s80">git stash comment01  </span><br/>
        <input id="stash_comment" type="text" placeholder="remote_name" />
        <button onClick="osrun('git stash \'' + $('#stash_comment').val() + '\'')" placeholder="git command" />add</button>
        <br/>
        new remote <span class="silver s80">git remote add branchname01 https://..../.git   </span><br/>
        <input id="remote_name" type="text" placeholder="remote_name" />
        <input id="remote_url" type="text" placeholder="remote_url" />
        <button onClick="osrun('git remote add  \'' + $('#remote_name').val() + '\' \'' + $('#remote_url').val() +'\'')" placeholder="git command" />add</button>
        <br/>
        new sub module <span class="silver s80">git submodule add submodulename01 https://..../.git   </span><br/>
        <input id="submodule_path" type="text" placeholder="submodule_path" />
        <input id="dir_name" type="text" placeholder="dir_name" />
        <br/>
        new local branch <span class="silver s80">git branch branchname01 </span><br/>
        <input id="new_branch_name" type="text" placeholder="branch name" />
        <button onClick="osrun('git branch ' + $('#new_branch_name').val())" placeholder="git command" />add</button>
        <br/>
        commit<br/>
        <input id="commit_msg" type="text" placeholder="commit_msg name" />
        <button onClick="osRunOut('git commit -m \'' + $('#commit_msg').val() + '\'','os_result')" placeholder="git command" />add</button>
        <br/>
    </div>

  </body>

  <script>

    require('./renderer.js')
    require('./functions.js')

      window.jQuery = window.$ = require('./jquery-3.1.0.js')

      const BrowserWindow = require('electron').remote.BrowserWindow // windowオブジェクト
      const path = require('path')

      local_repos =[]
      local_files =[]
      his_repo =[] // リポジトリ選択履歴
      current_repo_path = ""
      interval_log_filter = null // 入力完了からログ検索までの秒数

      execOption = { encoding: 'utf8',
                        timeout: 0,
                        maxBuffer: 2000*1024,  //200*1024
                        killSignal: 'SIGTERM',
                        cwd: '',
                        env: null }


      repo_btn_prev_push = "" //リポジトリ以下の母tなで直前push したもの
      top_filtered_repo = ""

    // You can also require other files to run in this process

    //enter押したら
    $('#filter_l_repo').keyup(function(e){
        console.log(e.which)
        if (e.which == 13 && top_filtered_repo) setRepoPath( top_filtered_repo )
    })


    showGitmodules = function(){
      var git_command = 'cat ' + path2dir( current_repo_path ) + '/.gitmodules'
      osRunCb(git_command,
        function(ret_ary){
          $('#repo_out').html(sRed(git_command) + " " + sGray(ret_ary.length) + '<br/>')
          $('#repo_out').append(ret_ary.join('<br/>'))

          togglePaneCurrentRepoDesc('gitmodule')
      })

    }

    showIgnore = function(){
      var git_command = 'cat .gitignore'
      osRunCb(git_command,
          function(ret_ary){
              $('#repo_out').html(sRed(git_command) + " " + sGray(ret_ary.length) + '<br/>' +
                                   ret_ary.join('<br/>'))
              togglePaneCurrentRepoDesc('ignore')
      })
    }
    showBranchList = function() {
        var git_command = 'git branch'
        osRunCb(git_command,function(ret_ary){
              $('#repo_out').html(sRed(git_command) + " " + sGray(ret_ary.length) + '<br/>' )
              for (var ind in ret_ary ){
                  var v1 = ret_ary[ind].trim()
                  $('#repo_out').append('<span onclick="checkOut(\'' + v1 + '\')" class="btn">' + v1 +'</span><br/>')
              }
              togglePaneCurrentRepoDesc('branch')
        })
    }

    showMemberList = function(){
        var cmd = 'git log --pretty=format:"%an" | sort | uniq -c | sort -r'
        osRunCb(cmd,
          function(ret_ary){
            out_str = sRed(cmd) + " " + ret_ary.length + '<br/>'
            out_str += "<table>"
            for (var ind in ret_ary) {

                var line = ret_ary[ind].trim()
                line_ary = line.match(/(\d+ )(.*$)/)

                class_str =""
                if (ind <= 20) class_str = 'class="s120"'
                if (ind <= 10) class_str = 'class="s150"'

                out_str += '<tr><td ' + class_str + '>' + sSilver((parseInt(ind) + 1 )) + '</td>' +
                              '<td ' + class_str + '><span onClick="logTable(\'' + line_ary[2] + '\')" class="btn">' + line_ary[2] + '</span></td>' +
                              '<td ' + class_str + '>' + line_ary[1] + '</td></tr>'
            }
            out_str += '<table>'
            $('#os_result').html(out_str)
          }
        )
    }

    togglePaneLocalRepoList = function (){
      if ($('#togglePaneLocalRepoList').css('display') == 'block' ){
          $('#togglePaneLocalRepoList').slideUp(10)
      }else{
          $('#local_repo_pane').slideDown(10)
          $('#filter_l_repo').val('')
          filterLocalRepos()
          $('#filter_l_repo').focus()
      }
    }

    togglePaneCurrentRepoDesc = function (key){

      //初回なら閉じる
      if (key == "") {
          $('#repo_out').slideUp(10)
          return
      }

      //開いてる項目を押したら閉じる
      if (repo_btn_prev_push == key && $('#repo_out').css('display') == 'block' ){
          $('#repo_out').slideUp(10)
      }else{
          $('#repo_out').slideDown(10)
      }
      repo_btn_prev_push=key
    }

    diffColor = function (ary){
        for (var ind in ary){
          var line = ary[ind]
          //line = escapeHTML(line)
           if (line[0]=='-') ary[ind] = sBlue(line)
           if (line[0]=='+') ary[ind] = sGreen(line)

        }
        return ary
    }

    showGitStatus = function(){

        osRunOut('git status -s','os_result')

        var com2 = 'git diff --cached'
        osRunCb(com2,
          function(ret_ary){
            for (var ind in ret_ary){
              var line = ret_ary[ind]
              line = escapeHTML(line)

               ret_ary[ind] = line
               if (line[0]=='-') ret_ary[ind] = sBlue(line)
               if (line[0]=='+') ret_ary[ind] = sGreen(line)

            }

            ret_ary = diffColor(ret_ary)
            var ret_out_str = ret_ary.join('<br/>')
            $('#os_result').append('<br/>' + sRed(escapeHTML(com2)) + " " + sGray(ret_ary.length) + '<br/>' + ret_out_str )
          }
        )
    }



    setCurrentBranchName = function(){
        osRunCb('git branch',function(ret_ary){
            for (var ind in ret_ary){
                if (ret_ary[ind].match(/\*/)){
                    $('#c_branch').html(ret_ary[ind].replace("*","").trim())
                }
            }
        })
    }

    checkOut = function ( branch_name ){
        osRunCb("git checkout '" + branch_name+ "'",
                  function(ret_ary){
                      console.log(ret_ary.join('<br/>'))
                      setRepoPath(current_repo_path)
                  })
    }

    findLocalRepos = function(){
      osRunCb("find ~ -type d -maxdepth 7 | egrep '/\.git$' ",
        function( ret_ary ){

            local_repos = ret_ary
            togglePaneLocalRepoList()
            filterLocalRepos('')
        }
      )
    }
    filterLocalRepos = function (){

      var filter = $('#filter_l_repo').val()

      $('#local_repo_list').html("<table>");
      top_filtered_repo =""
      for (var ind in local_repos){
          var full_path = local_repos[ind]
          fname = path2pjname(full_path)
          fname_disp = fname

          if (filter) {

              var re = new RegExp('('+filter+')','i')
              if (!fname.match(re)) continue;

              if (!top_filtered_repo) top_filtered_repo = full_path
              fname_disp = fname_disp.replace(re,sRed('$1'))
          }
          $('#local_repo_list').prepend('<tr><td> <a href="javascript:void(0)" onClick="setRepoPath(\'' + full_path + '\')" class="btn s150">' +
                                    fname_disp + '</span> </td><td> &nbsp; ' + sSilver(s80(full_path.replace(fname,sGray2(fname)) )) + '</td></tr>')
      }
      $('#local_repo_list').append("</table>");

    }


    // set local repository
    setRepoPath = function(full_path) {
        console.log(full_path)

        current_repo_path = full_path
        execOption.cwd = path2dir(current_repo_path)

        $('#current_repo_name').html( path2pjname(full_path) )
        $('#current_repo_path').html( full_path )
        $('#local_repo_pane').slideUp(10)

        his_repo[current_repo_path] = "";
        $('#his_repo').html("")
        for (var name in his_repo){
          $('#his_repo').append('<span onClick="setRepoPath(\'' + name + '\');" class="history s80">' + path2pjname(name) + '</span> ');
        }
        setCurrentBranchName()
        togglePaneCurrentRepoDesc("") // close

        osRunOneLine('git ls-files | wc -l', 'br_files_ct')
        osRunOneLine('git log --oneline | wc -l', 'br_commit_ct')
        //osRunOneLine('git log --date=relative --pretty=format:"%ad  : %h  : %an : %s" | head -1', 'latest_commit')
        osRunOneLine('git log --date=relative --pretty=format:"%ad" | head -1', 'latest_commit')
        osRunOneLine('git log --pretty=format:"%an" | sort | uniq | wc -l', 'br_member_ct')


        //サブモジュールやremote情報
        // $('#c_repo_info').html("")
        // var config_lines = fs.readFileSync (full_path + '/config').toString().split(/\n/)
        // for (var ind in config_lines){
        //     var line = config_lines[ind]
        //     if ( line.match(/\[.*remote/)) $('#c_repo_info').append( sRed('remote ') + line.replace(/(.*")(.*?)(".*)/,'$2') + '<br/>')
        //     if ( line.match(/\[.*branch/)) $('#c_repo_info').append( sRed('branch ') + line.replace(/(.*")(.*?)(".*)/,'$2')  + '<br/>')
        //     if ( line.match(/\[.*submodule/)) $('#c_repo_info').append( sRed('submodule ') + line.replace(/(.*")(.*?)(".*)/,'$2')  + '<br/>')
        // }

        // local branch & remote branch
        osRunCb('git branch',function( ret_ary ){
            $('#local_branch_ct').html(ret_ary.length)
        })
        osRunCb('git branch -r',function( ret_ary ){
            $('#remote_branch_ct').html(ret_ary.length)
        })

        //ファイル一覧
        osRunCb('ls ' + full_path ,
          function(ret_ary){
              $('#c_repo_pane').html("")
              for (var ind in ret_ary){
                  file_disp = ret_ary[ind]
                  var stat = fs.statSync(full_path + '/' + file_disp )
                  if (stat.isDirectory()) file_disp = sBlue(file_disp)
                  $('#c_repo_pane').append(file_disp + '<br/>')

                  if (stat.isFile()) {
                      var ret = fs.readFileSync (full_path + '/' + file_disp)
                      ret = ret.toString().substring(0,500).replace(/\n/g,'<br/>')
                      $('#c_repo_pane').append('<div name="file_detail" class="m10 hide">' + s60(sSilver(ret)) + '</div>')
                  }
              }
          }
        )
        $('#repo_info').show()
    }


    showFiles = function(filter){
        var git_command = 'git ls-files '
        if (filter) git_command += " | egrep -i '" + filter + "'"
        git_command += ' | head -2000'

        osRunCb(git_command,
          function(ret_ary){

            var htmlstr= '  <div class="s150">Files</div> <input type="text" id="filter_files" value="' + filter + '"size=10 > <br/>'
            $('#os_result').html(htmlstr)
            $('#os_result').append(sRed(escapeHTML(git_command)) + " " + sGray(ret_ary.length) + '<br/>')

            var str_out =""
            for (var ind in ret_ary){
              str_out += '<a onClick="fileStat(\'' + ret_ary[ind].trim() + '\')" href="javascript:void(0);" >' + ret_ary[ind].replace(new RegExp('(' + filter.trim() + ')','ig'),sRed('$1') ) + '</a><br/>'
            }

           $('#os_result').append(str_out )
           $('#filter_files').focus()

           //0.2秒たったら
           //interval_log_filter =

           //enter押したら
           $('#filter_files').keyup(function(e){
             console.log(e.which)
               if (e.which == 13) showFiles( $('#filter_files').val() )
           })
        })
    }

    fileStat = function(filepath){

      $('#os_result').html("")

      var git_command = 'git log -p --oneline --follow --name-status --date=short --pretty=format:" %ad %h  %an %s " '  + filepath.trim()
      osRunCb(git_command,
        function(ret_ary){
          console.log('retary',ret_ary)

          var htmlstr = s150(filepath) + '<br/>'
          htmlstr += sRed(escapeHTML(git_command)) + " " + sGray(ret_ary.length) + '<br/>'
          var str_out = ret_ary.join('<br/>')
          $('#os_result').append( htmlstr + str_out + '<br/><br/>')
      })

      var git_command2 = 'git log -p --oneline --pretty=format:" %ad %x09 %h %x09 %an %x09 %s" '  + filepath.trim()
      osRunCb(git_command2,
        function(ret_ary){


          htmlstr = sRed(escapeHTML(git_command)) + " " + sGray(ret_ary.length) + '<br/>'
          for (var ind in ret_ary){
            ret_ary[ind] = escapeHTML(ret_ary[ind])
          //  str_out += '<a onClick="fileStat(\'' + ret_ary[ind].trim() + '\')" href="javascript:void(0);" >' + ret_ary[ind].replace(new RegExp('(' + filter.trim() + ')','ig'),sRed('$1') ) + '</a><br/>'
          }
          ret_ary = diffColor(ret_ary)

          var str_out = ret_ary.join('<br/>')
          $('#os_result').append( htmlstr + str_out )
      })



    }

    logTable = function( filter ){
         var git_command = 'git log --date=relative --pretty=format:"<tr><td nowrap > %ad %x09 %h %x09 %an %x09 %s </td></tr>"'
         if (filter) git_command += " | egrep -i '" + filter + "'"
         git_command += ' | head -2000'

         osRunCb(git_command,
           function(ret_ary){

             var htmlstr= '  <div class="s150">Log</div> <input type="text" id="filter_log" value="' + filter + '"size=10 > <br/>'
             $('#os_result').html(htmlstr)
             $('#os_result').append(sRed(escapeHTML(git_command)) + " " + sGray(ret_ary.length) + '<br/>')
             var str_out = ret_ary.join('')
             str_out = str_out.replace(/\t/g,'</td><td nowrap >')
             if (filter) str_out = str_out.replace(new RegExp('(' + filter.trim() + ')','ig'),sRed('$1') )

            $('#os_result').append('<table>' + str_out + '</table>')
            $('#filter_log').focus()

            //0.2秒たったら
            //interval_log_filter =

            //enter押したら
            $('#filter_log').keyup(function(e){
              console.log(e.which)
                if (e.which == 13) logTable( $('#filter_log').val() )
            })
         })
     }

    //初期処理
    osRunOneLine('git version', 'version')
    osRunOneLine('node -v', 'node_version')

    var git_command1 = 'node -v'
    osRunCb(git_command1, function(ret_ary){
      $('#nodejs_info').append(sRed(git_command1) + '<br/>' + ret_ary.join('<br/>') + '<br/>')
    })
    var git_command2 = 'npm -g list'
    osRunCb( git_command2, function(ret_ary){
      $('#nodejs_info').append(sRed(git_command2) + '<br/>' + ret_ary.join('<br/>') + '<br/>')
    })
    osRunCb('npm -g list', 'nodejs_info')

    var com2 = 'git config --global --list'
    osRunCb( com2 ,
      function(ret_ary){
        for (var ind in ret_ary ){
            if (ret_ary[ind].match(/(name|email)/)) $('#g_user').append(ret_ary[ind].replace(/.*=/,'') + ' &nbsp; ')
        }
        $('#gitconf').append( sRed(com2) + '<br/>' + ret_ary.join('<br/>').replace(/ /g,'&nbsp;') + '<br/>' )
      })
    osrun('cat ~/.gitignore_global','gitconf')
    findLocalRepos()


    const {ipcRenderer} = require('electron')
    toggleDevTools = function(){  ipcRenderer.send('toggleDevTool', 'ping')   }


    $('#filter_l_repo').keyup(function(e){
        filterLocalRepos()
    })

    </script>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Git-tron</title>
    <link href="./style.css" rel="stylesheet" type="text/css" />
  </head>
  <body>

    <!-- header -->

    <div class="underline" style="padding:3px;">
      <table width="100%" style="padding:0px;margin:0px;"><tr>
        <td width="50%" valign="top" >
            <span id="version" class="silver s80" >**version**</span>
            <span onClick="toggleDevTools()" class="btn s80" >devTools</span>
            <span onClick="$('#node_info').slideToggle(10)" class="btn s80" >node</span>

        </td>
        <td width="50%" align="right" >
          <span id="g_user" class="silver s80" ></span>
          <span onClick="$('#gitconf').toggle();" class="btn s80"> ~/.gitconfig ~/.gitignore_global</span>

          <br/>
          <div id="gitconf" class="hide s80 detail" style="text-align:left;"></div>

        </td>
      </tr></table>

      <div id="node_info" class="detail hide">aaaa</div>

      <span onClick="toggleLocalRepoListPane()" class="btn" >Repositories</span>
      <span onClick="alert('construction');" class="btn s80" >init</span>
      <span id="his_repo"></span>
    </div>

    <!-- local repositories -->

    <div id="local_repo_pane" class="detail" >
      <input type="text" id="filter_l_repo" size=20 />
      <div id="local_repo_list"></div>
    </div>

    <div id="repo_info" class="m10 hide">
        <span id="current_repo_path" class="bold">**current_repo**</span>
        <span onClick="osrun('open ' + path2dir(current_repo_path) )"  class="btn s80">finder</span>
        <br/>

        <span onClick="showBranchList()" class="btn">branch</span>
        <span id="local_branch_ct" class="pink">**local_branch_ct**</span>

        <span onClick="showIgnore()" class="btn">.gitignore</span>
        <span onClick="osrun('ls ' + current_repo_path + '/hooks','repo_out'); toggleLocalRepoInfoPane('hooks')" class="btn">hooks</span>
        <span onClick="osrun('git submodule status','repo_out'); toggleLocalRepoInfoPane('hooks')" class="btn">submodule</span>

        <span onClick="showGitmodules()" class="btn">.gitmodules</span>

        <span onClick="osrun('git stash list','repo_out'); toggleLocalRepoInfoPane('stash')" class="btn">stash</span>
        <span onClick="osrun('cat ' + current_repo_path + '/config','repo_out'); toggleLocalRepoInfoPane('config')" class="btn">config</span>


        Remote
        <span onClick="osrun('git remote -v','repo_out'); toggleLocalRepoInfoPane('remote')" class="btn">repo</span>
        <span onClick="osrun('git branch -r','repo_out'); toggleLocalRepoInfoPane('remotebranch')"  class="btn">branch</span>
        <span id="remote_branch_ct" class="pink">**remote_branch_ct**</span>

        <br/>

        <div id="repo_out" class="s80 hide detail" >repo_out</div>

        <span id="c_branch" class="s150 bold">**c_branch**</span>

        <span class="gray">
          files<span id="br_files_ct" class="s120 bold">**br_files_ct**</span>
          commit<span id="br_commit_ct" class="s120 bold">**br_commit_ct**</span>
           <span id="latest_commit" class="s80 gray">97f809b  4 minutes ago</span>
        </span>
        <br/>

        <span onClick="osrun('git status -s','os_result')"  class="btn">status</span>
        <span onClick="osrun('git add .','os_result')"  class="btn">add</span>
        <span onClick="osrun('git reset','os_result')"  class="btn">reset</span>
        <span onClick="osrun('git diff ','os_result')"  class="btn s80">diff</span>
        <span onClick="osrun('git ls-files ','os_result')"  class="btn s80">allfiles</span>

        <span class="s80 gray">ChangeFiles</span>


        <span onClick="osrun('git diff HEAD~5 HEAD --name-only ','os_result')" class="btn s80">5c</span>
        <span onClick="osrun('git diff HEAD~10 HEAD --name-only ','os_result')" class="btn s80">10c</span>
        <span onClick="osrun('git diff HEAD~30 HEAD --name-only ','os_result')" class="btn s80">30c</span>
        <span onClick="osrun('git diff HEAD~100 HEAD --name-only ','os_result')" class="btn s80">100c</span>

        <span onClick="logTable('')" class="btn s80">Log</span>
        <span onClick="osrun('git log --graph ','os_result')" class="btn s80">tree</span>
        <span onClick="osrun('git log --graph --oneline ','os_result')" class="btn s80">tree1</span>

        <input id="git_usercommand" type="text" size="70" placeholder="git command" />
        <button onClick="osrun($('#git_usercommand').val(),'os_result')" placeholder="git command" />run</button>

        <div id="os_result" class="detail s80">os_result</div>

        <div class="m10">
            current repo info
            <span onClick="findLocalRepos()" class="btn s80">files</span>
            <div id="c_repo_info" class="underline s80"> </div>

            <span onClick="$('div[name=file_detail]').toggle();" class="btn">toggle</span>
            btn
            <br/>
            <span id="c_repo_pane" >c_repo_pane</span>
        </div>

        <br/><br/>
        <div id="real_files"></div>

        <div id="os_out" style="font-size:60%;font-color:silver;"></div>
        init<br/>
        <input id="init_path" type="text" placeholder="init_path" />
        <button onClick="osrun('git remote add  \'' + $('#remote_name').val() + '\' \'' + $('#remote_url').val() +'\'')" placeholder="git command" />add</button>

        <br/>
        clone url<br/>
        <input id="clone_url" type="text" placeholder="clone_url" />
        <br/>
        stash <span class="silver s80">git stash comment01  </span><br/>
        <input id="stash_comment" type="text" placeholder="remote_name" />
        <button onClick="osrun('git stash \'' + $('#stash_comment').val() + '\'')" placeholder="git command" />add</button>
        <br/>
        new remote <span class="silver s80">git remote add branchname01 https://..../.git   </span><br/>
        <input id="remote_name" type="text" placeholder="remote_name" />
        <input id="remote_url" type="text" placeholder="remote_url" />
        <button onClick="osrun('git remote add  \'' + $('#remote_name').val() + '\' \'' + $('#remote_url').val() +'\'')" placeholder="git command" />add</button>
        <br/>
        new sub module <span class="silver s80">git submodule add submodulename01 https://..../.git   </span><br/>
        <input id="submodule_path" type="text" placeholder="submodule_path" />
        <input id="dir_name" type="text" placeholder="dir_name" />
        <br/>
        new local branch <span class="silver s80">git branch branchname01 </span><br/>
        <input id="new_branch_name" type="text" placeholder="branch name" />
        <button onClick="osrun('git branch ' + $('#new_branch_name').val())" placeholder="git command" />add</button>
        <br/>
        commit<br/>
        <input id="commit_msg" type="text" placeholder="commit_msg name" />
        <button onClick="osrun('git commit -m \'' + $('#commit_msg').val() + '\'')" placeholder="git command" />add</button>
        <br/>
    </div>

  </body>

  <script>
    // You can also require other files to run in this process
    require('./renderer.js')
    require('./functions.js')

    window.jQuery = window.$ = require('./jquery-3.1.0.js')

    const BrowserWindow = require('electron').remote.BrowserWindow // windowオブジェクト
    const path = require('path')

    local_repos =[]
    local_files =[]
    his_repo =[] // リポジトリ選択履歴
    current_repo_path = ""

    execOption = { encoding: 'utf8',
                      timeout: 0,
                      maxBuffer: 2000*1024,  //200*1024
                      killSignal: 'SIGTERM',
                      cwd: '',
                      env: null }


    repo_btn_prev_push = "";//リポジトリ以下の母tなで直前push したもの

    showGitmodules = function(){
      var git_command = 'cat ' + path2dir( current_repo_path ) + '/.gitmodules'
      osRunCb(git_command,
        function(ret_ary){
          $('#repo_out').html(sRed(git_command) + " " + sGray(ret_ary.length) + '<br/>')
          $('#repo_out').append(ret_ary.join('<br/>'))

          toggleLocalRepoInfoPane('gitmodule')
      })

    }

    showIgnore = function(){
      var git_command = 'cat .gitignore'
      osRunCb(git_command,
          function(ret_ary){
              $('#repo_out').html(sRed(git_command) + " " + sGray(ret_ary.length) + '<br/>' +
                                   ret_ary.join('<br/>'))
              toggleLocalRepoInfoPane('ignore')
      })
    }
    showBranchList = function() {
        var git_command = 'git branch'
        osRunCb(git_command,function(ret_ary){
              $('#repo_out').html(sRed(git_command) + " " + sGray(ret_ary.length) + '<br/>' )
              for (var ind in ret_ary ){
                  var v1 = ret_ary[ind].trim()
                  $('#repo_out').append('<span onclick="checkOut(\'' + v1 + '\')" class="btn">' + v1 +'</span><br/>')
              }
              toggleLocalRepoInfoPane('branch')
        })
    }


    toggleLocalRepoListPane = function (){
      if ($('#toggleLocalRepoListPane').css('display') == 'block' ){
          $('#toggleLocalRepoListPane').slideUp(10)
      }else{
          $('#local_repo_pane').slideDown(10)
          $('#filter_l_repo').val('')
          filterLocalRepos()
          $('#filter_l_repo').focus()
      }
    }

    toggleLocalRepoInfoPane = function (key){

      //初回なら閉じる
      if (key == "") {
          $('#repo_out').slideUp(10)
          return
      }

      //開いてる項目を押したら閉じる
      if (repo_btn_prev_push == key && $('#repo_out').css('display') == 'block' ){
          $('#repo_out').slideUp(10)
      }else{
          $('#repo_out').slideDown(10)
      }
      repo_btn_prev_push=key
    }

    setCurrentBranchName = function(){
        osRunCb('git branch',function(ret_ary){
            for (var ind in ret_ary){
                if (ret_ary[ind].match(/\*/)){
                    $('#c_branch').html(ret_ary[ind].replace("*","").trim())
                }
            }
        })
    }

    checkOut = function ( branch_name ){
        osRunCb("git checkout '" + branch_name+ "'",
                  function(ret){
                      setRepoPath(current_repo_path)
                  })
    }

    findLocalRepos = function(){
      osRunCb("find ~ -type d -maxdepth 7 | egrep '/\.git$' ",
        function( ret_ary ){

            local_repos = ret_ary
            toggleLocalRepoListPane()
            filterLocalRepos('')
        }
      )
    }
    filterLocalRepos = function (){

      var filter = $('#filter_l_repo').val()

      $('#local_repo_list').html("<table>");
      for (var ind in local_repos){
          var full_path = local_repos[ind]
          fname = path2pjname(full_path)
          fname_disp = fname

          if (filter) {
              var re = new RegExp('('+filter+')','i')
              if (!fname.match(re)) continue;
              fname_disp = fname_disp.replace(re,sRed('$1'))
          }
          $('#local_repo_list').prepend('<tr><td> <span onClick="setRepoPath(\'' + full_path + '\')" class="btn s150">' +
                                    fname_disp + '</span> </td><td> &nbsp; ' + sSilver(s80(full_path.replace(fname,sGray2(fname)) )) + '</td></tr>')
      }
      $('#local_repo_list').append("</table>");

    }


    // set local repository
    setRepoPath = function(full_path) {
        console.log(full_path)
        current_repo_path = full_path
        execOption.cwd = current_repo_path
        $('#current_repo_path').html( s150(path2pjname(full_path)) + ' ' + s80(sSilver(full_path)) )
        $('#local_repo_pane').slideUp(10)

        his_repo[current_repo_path] = "";
        $('#his_repo').html("")
        for (var name in his_repo){
          $('#his_repo').append('<span onClick="setRepoPath(\'' + name + '\');" class="history s80">' + path2pjname(name) + '</span> ');
        }
        setCurrentBranchName()
        toggleLocalRepoInfoPane("") // close

        osRunOneLine('git ls-files | wc -l', 'br_files_ct')
        osRunOneLine('git log --oneline | wc -l', 'br_commit_ct')
        osRunOneLine('git log --date=relative --pretty=format:"%ad  : %h  : %an : %s" | head -1', 'latest_commit')

        //サブモジュールやremote情報
        $('#c_repo_info').html("")
        var config_lines = fs.readFileSync (full_path + '/config').toString().split(/\n/)
        for (var ind in config_lines){
            var line = config_lines[ind]
            if ( line.match(/\[.*remote/)) $('#c_repo_info').append( sRed('remote ') + line.replace(/(.*")(.*?)(".*)/,'$2') + '<br/>')
            if ( line.match(/\[.*branch/)) $('#c_repo_info').append( sRed('branch ') + line.replace(/(.*")(.*?)(".*)/,'$2')  + '<br/>')
            if ( line.match(/\[.*submodule/)) $('#c_repo_info').append( sRed('submodule ') + line.replace(/(.*")(.*?)(".*)/,'$2')  + '<br/>')
        }

        // local branch & remote branch
        osRunCb('git branch',function( ret_ary ){
            $('#local_branch_ct').html(ret_ary.length)
        })
        osRunCb('git branch -r',function( ret_ary ){
            $('#remote_branch_ct').html(ret_ary.length)
        })

        //ファイル一覧
        osRunCb('ls ' + full_path ,
          function(ret_ary){
              $('#c_repo_pane').html("")
              for (var ind in ret_ary){
                  file_disp = ret_ary[ind]
                  var stat = fs.statSync(full_path + '/' + file_disp )
                  if (stat.isDirectory()) file_disp = sBlue(file_disp)
                  $('#c_repo_pane').append(file_disp + '<br/>')

                  if (stat.isFile()) {
                      var ret = fs.readFileSync (full_path + '/' + file_disp)
                      ret = ret.toString().substring(0,500).replace(/\n/g,'<br/>')
                      $('#c_repo_pane').append('<div name="file_detail" class="m10 hide">' + s60(sSilver(ret)) + '</div>')
                  }
              }
          }
        )
        $('#repo_info').show()
    }

    logTable = function( filter ){
         var git_command = 'git log --date=relative --pretty=format:"<tr><td nowrap > %ad </td><td nowrap > %h </td><td nowrap > %an </td><td nowrap > %s </td></tr>"'
         if (filter) git_command += " | egrep -i '" + filter + "'"
         git_command += ' | head -2000' 

         osRunCb(git_command,
           function(ret_ary){

             var htmlstr= '  <input type="text" id="filter_log" value="' + filter + '"size=10 > <br/>'
             $('#os_result').html(htmlstr)
             $('#os_result').append(sRed(escapeHTML(git_command)) + " " + sGray(ret_ary.length) + '<br/>')
             var str_out = ret_ary.join('')
             if (filter) str_out = str_out.replace(new RegExp('(' + filter.trim() + ')','ig'),sRed('$1') )

            $('#os_result').append('<table>' + str_out + '</table>')

            $('#filter_log').focus()
         })
     }





    //初期処理
    osRunOneLine('git version', 'version')

    git_command = 'node -v'
    osRunCb(git_command, function(ret_ary){
      $('#node_info').append(ret_ary.join('<br/>'))
    })
    git_command = 'node -v'
    osRunCb( git_command, function(ret_ary){
      $('#node_info').append(ret_ary.join('<br/>'))
    })
    osRunCb('npm -g list', 'node_info')

    var com2 = 'git config --global --list'
    osRunCb( com2 ,
      function(ret_ary){
        for (var ind in ret_ary ){
            if (ret_ary[ind].match(/(name|email)/)) $('#g_user').append(ret_ary[ind].replace(/.*=/,'') + ' &nbsp; ')
        }
        $('#gitconf').append( sRed(com2) + '<br/>' + ret_ary.join('<br/>') + '<br/>' )
      })
    osrun('cat ~/.gitignore_global','gitconf')
    findLocalRepos()

    const {ipcRenderer} = require('electron')
    toggleDevTools = function(){  ipcRenderer.send('toggleDevTool', 'ping')   }
    $('#filter_l_repo').keyup(function(e){
        filterLocalRepos()
    })


    </script>
</html>
